{% extends 'layout.twig' %} {% block body %} <script>
  $(document).ready(function () {
    // TABLE STUFF
    $('.oncall').html('On-call pickup only');
    $('#master-table').DataTable({
      'paging': false,
      'searching': false,
      'info': false,
      'dom': 't',
      'columns': [{
        "title": "Route"
      }, {
        "title": "Next Date"
      }]
    });

    function hidePast() {
      $("#master-table td:nth-child(2)").each(function () {
        if ($(this).text().indexOf("No more") != -1 || $(this).text().indexOf("On-call") != -1) {
          $(this).parent("tr").css("display", "none");
        }
      });
    }

    function showPast() {
      $("#master-table td:nth-child(2)").each(function () {
        if ($(this).text().indexOf("No more") != -1 || $(this).text().indexOf("On-call") != -1) {
          $(this).parent("tr").css("display", "table-row");
        }
      });
    }
    $('#toggle-past').click(function () {
      if ($('#toggle-past').is(':checked')) {
        hidePast();
      } else {
        showPast();
      }
    });
  });
</script>
<h1><img class="logo" src="images/raccoon.svg" /> {{title}}</h1>
<hr />
<p>Welcome to {{title}}. We are tracking {{areacount}} areas. &nbsp; &#9758;Work in progress&#9756;</p>
<pre id="dump"><!--a useful twig dump: dump(datearr[2].geometry[0][0])--></pre>
<div class="row">
  <div class="col-xs-12 col-sm-6 col-md-6 col-lg-5">
    <p><input type="checkbox" id="toggle-past" name="toggle" value="0" />
      <label for="toggle-past">Hide areas that don't have any more dates this year</label></p>
    <table id="master-table" class="table table-sm table-bordered sortable">
      <tbody> {% for object in datearr %} <tr scope="row">
          <td>{{datearr[loop.index0].route}}</td>
          <td data-sort={{datearr[loop.index0].nextdatesortable}} class={{datearr[loop.index0].nextdateclass}}>{{datearr[loop.index0].nextdate}}</td>
        </tr> {% endfor %} </tbody>
    </table>
  </div>
  <div class="col-xs-12 col-sm-6 col-md-6 col-lg-7">
    <div id="map"></div>
  </div>
</div> {% block footer %} <footer>
  <hr />
  <p>App by <a href="mailto:emily@empul.se">emily@empul.se</a> &nbsp; | &nbsp; Icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">flaticon.com</a> &nbsp; | &nbsp; Data from <a href="https://data.austintexas.gov/Locations-and-Maps/Bulk-Item-Collection-Routes/qxkq-859w">The City of Austin</a></p>
</footer> {% endblock %} 


<script>
  // MAP STUFF
  // initial display
  var mymap = L.map('map').setView([30.259152, -97.759355], 11);
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZW1rYW1wIiwiYSI6ImNrMjI5OWtiMTBobXMzaG9jZXlsbWs4cjIifQ.yjzXANzD64mac1HK-JRC4w', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets',
    accessToken: 'pk.eyJ1IjoiZW1rYW1wIiwiYSI6ImNrMjI5OWtiMTBobXMzaG9jZXlsbWs4cjIifQ.yjzXANzD64mac1HK-JRC4w'
  }).addTo(mymap);

  var routeLayer = [];
  //alert(title); cannot work.  alert("{{ title }}"); this works!

  {% for object in datearr %}
    var thisGeom = {{datearr[loop.index0].geometry|json_encode}}; //object with 2 key val pairs: type:"multipolygon" and coordinates:[[array]]
    thisGeom.class = {{datearr[loop.index0].nextdateclass|json_encode}}; //adding that class i flew in from index.js at same level as type and coordinates
    //console.log(thisGeom);
    routeLayer.push(thisGeom); //add the object we just built
  {% endfor %}
  
  console.log(routeLayer); //check on each region's object
  
  L.geoJSON(routeLayer, { //add appropriate style for each object in teh array as we add it to the map
	style: function(feature) {
		switch (feature.geometry.class) {
			case 'past': return {color: "#777"};
			case 'on-call': return {color: "#a70"};
      case 'upcoming': return {color: "#092"};
		}
	}
}).addTo(mymap);

</script>
{% endblock %}